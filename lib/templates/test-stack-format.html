<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>堆栈信息格式化测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stack-trace-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .stack-line {
            padding: 12px 15px 12px 45px;
            border-bottom: 1px solid #e9ecef;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            position: relative;
            transition: background-color 0.2s;
            word-break: break-all;
        }

        .stack-line:last-child {
            border-bottom: none;
        }

        .stack-line:hover {
            background: #e9ecef;
        }

        .stack-line:before {
            content: attr(data-line);
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 11px;
            background: #dee2e6;
            border-right: 1px solid #adb5bd;
            font-weight: 500;
        }

        .location-highlight {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #bbdefb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h2>堆栈信息格式化测试</h2>
        <div id="output"></div>
    </div>

    <script src="error-detail.js"></script>
    <script>
        // 测试用的堆栈信息
        const testStack = `Error: Cannot resolve module 'react-native-vector-icons/MaterialIcons' from '/Users/project/src/components/Icon.js'
    at ModuleResolver.resolveDependency (/Users/project/node_modules/@react-native-community/cli/build/tools/loadMetroConfig.js:69:23)
    at DependencyGraph.resolveDependency (/Users/project/node_modules/metro/src/node-haste/DependencyGraph.js:287:43)
    at Object.resolve (/Users/project/node_modules/metro/src/lib/transformHelpers.js:267:42)
    at /Users/project/node_modules/metro/src/DeltaBundler/traverseDependencies.js:396:31
    at Generator.next (<anonymous>)
    at asyncGeneratorStep (/Users/project/node_modules/metro/src/DeltaBundler/traverseDependencies.js:87:24)`;

        // 模拟error-detail页面的方法
        const mockErrorDetailPage = {
            highlightFileLocation: function(line) {
                if (!line) return line;
                
                // 匹配文件路径和行列号的正则表达式
                const locationRegex = /([^\s\(\)]+\.(js|ts|vue|jsx|tsx|css|scss|less|html|json)):(\d+):(\d+)/g;
                
                return line.replace(locationRegex, (match, filePath, ext, lineNum, colNum) => {
                    // 保持完整路径，只高亮行列号
                    return `${filePath}:<span class="location-highlight">${lineNum}:${colNum}</span>`;
                });
            },

            formatStackTrace: function(stack) {
                if (!stack) return '';
                
                let stackLines = [];
                
                // 如果stack是字符串，处理换行和at替换
                if (typeof stack === 'string') {
                    stackLines = stack
                        .replace(/\s*at\s+/g, '\n@ ')  // 将 "at " 替换为 "@ " 并添加换行
                        .replace(/^\n/, '')  // 移除开头的换行
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0);
                }
                
                // 返回结构化的HTML
                return stackLines.map((line, index) => {
                    const processedLine = this.highlightFileLocation(line);
                    return `<div class="stack-line" data-line="${index + 1}">${processedLine}</div>`;
                }).join('');
            }
        };

        // 渲染测试结果
        const output = document.getElementById('output');
        const formattedStack = mockErrorDetailPage.formatStackTrace(testStack);
        output.innerHTML = `
            <h3>原始堆栈信息：</h3>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px;">${testStack}</pre>
            
            <h3>格式化后的堆栈信息：</h3>
            <div class="stack-trace-container">
                ${formattedStack}
            </div>
        `;
    </script>
</body>
</html>
